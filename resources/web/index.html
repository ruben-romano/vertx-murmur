<html>
	<head>
		
		<link href="scripts/semantic-ui/css/semantic.css" rel="stylesheet" type="text/css"></link>
		<link href="styles/murmur.css" rel="stylesheet" type="text/css"></link>		
		
		<script src="scripts/lib/sockjs.min.js"></script>
		<script src="scripts/lib/vertxbus.js"></script>
		<script src="scripts/lib/react.js"></script>
		<script src="scripts/lib/JSXTransformer.js"></script>
		<script src="scripts/lib/jquery-2.1.1.min.js"></script>
		<script src="scripts/lib/jquery.cookie.js"></script>
		<script src="scripts/semantic-ui/javascript/semantic.js"></script>

	</head>
	<body>
		<div class="container">					
			<div class="ui">
				<div class="ui inverted segment site-header">
					<i class="circular inverted black users icon">
					</i>
					<div class="ui icon input chat-input">
					  <input type="text" placeholder="Chat..." id="chat-input" autofocus />
					  <i class="comment icon"></i>
					</div>
					<div class="ui right floated huge header">murmur</div>	
				</div>							
			</div>	
		</div>

		<script type="text/jsx" src="scripts/murmur/vertx-eventbus.js"></script>
		<script type="text/jsx" src="scripts/murmur/components/chat.js"></script>
		<script type="text/jsx" src="scripts/murmur/components/chat-list.js"></script>
		<script type="text/jsx" src="scripts/murmur/components/chat-box.js"></script>

		<div id="chat-box-content"></div>		

		<!-- Login Modal -->
		<div class="ui small modal">
			<div class="ui one column middle aligned relaxed grid basic segment">
			  <div class="column">
			    <div class="ui center aligned form segment">
			      <div class="ui header">
			        <label class="ui large header">murmur</label>
			        <div class="ui fluid left icon input">
			          <input type="text" placeholder="Username" id="username-input">
			          <i class="user icon"></i>
			        </div>
			      </div>
			      <div class="ui black submit button" id="login-button">Login</div>
			    </div>
			  </div>
			</div>
		</div>
		<script>
			var loginButton = $("#login-button");
			loginButton.click(function() {
				eb = new vertx.EventBus('http://localhost/eventbus');
				currentUser = $("#username-input").val();				
				eb.onopen = function() {
				  // Setup publish queue to listen to message and user notification events	
				  eb.registerHandler('user.' + currentUser, function(message) {
				    var receiveTxt = $("#receiveTextArea");		        
				    receiveTxt.val(message.message + "\n" + receiveTxt.val());
				    data.unshift(message);
				    updateChatList(data);
				    console.log('received a message: ' + JSON.stringify(message));
				  });

				  // retrieve list of messages for the current user
			  	  eb.send('find-messages',
					{ user: currentUser },
					function(reply) {
						console.log('messages received: ' + JSON.stringify(reply));
						messageStore = reply;
						chatlist = messageStore[currentRecipient];
						if (typeof chatlist == 'undefined') {
							return;
						}
						data.pop();
						for (var i=0; i < chatlist.length; i++) {
							data.push(chatlist[i]);
						}
						updateChatList(data);						
					}
				  );
				}

				$('.small.modal')
					.modal('hide');
			}); 
		</script>
		
		<script>		
			var chatInput = $('#chat-input');
			chatInput.keypress(function(e) {
			    if(e.which == 13) {			
			    	var message = chatInput.val();    	
			        chatInput.val("");
					
					if (message.trim() == "") {
						return;
					}		

					eb.send('persist-message', 
						{ 
							from : currentUser, 
							to : currentRecipient,
							message : message
						}, 
						function(reply) {
							data.unshift(reply);
							updateChatList(data);
							console.log('received a reply: ' + JSON.stringify(reply));
						}
					);
			    }
			});		
		</script>

	</body>
</html>
